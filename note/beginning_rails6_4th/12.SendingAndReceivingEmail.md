## Sending and Receiving Email

Action Mailer, 是Rails里用于发送邮件的框架, Action Mailbox, 则是Rails6之后新增加的用于接收邮件的框架.
本章以这两个框架如何在Rails里使用为准进行解释.

### Setting Up Action Mailer

Action Mailer的使用方式和其他的集成框架差不多, 只需要配置好邮件发送的服务器等, 把模版改改, 设定怎么在controller里触发就OK了.

由于Rails并没有提供一个内置的邮件服务器, 因此邮件发送一定需要第三方的服务器支持才可以.

#### Configuring Mail Server Settings

Action Mailer可以通过2种服务方式发送邮件

1. `sendmail`
2. SMTP服务器

`sendmail`可以直接在linux类服务器上调用, 不需要任何配置. 而如果是windows, 则必须配置SMTP服务器.

Action Mailer的配置项会被直接设定在`ActionMailer::Base`类上, 因此这些配置都需要在`environments`文件里进行配置,  或者通过`config/initializers`文件来进行初始化配置(这个文件夹也是项目启动时会全部去加载的文件, 分开的原因在于分开配置管理).

如果需要设定SMTP服务器, 则需要设定`smtp_settings`配置项, 他又分为如下内容

Setting | Description |
---|---|
address | 邮件服务器发送地址, 默认是localhost
port | 邮件服务器发送端口, 默认是25
domain | 如需要响应多个域名, 则需要在这里配置
authentication | 登录用的token, 支持`:plain, :login, :cram_md5`
user_name | 登录服务器用的用户名
password | 登录服务器用的密码

#### Storing Sensitive Secrets

项目开发谨记配置与代码分离的原则, 对于登录服务器用的敏感信息, 不要直接写在项目代码里, 可以有多种存储方式, 最为常用的就是Rails的`ENV`,或者`credentials`.

`config/master.key`是默认不会被Rails项目擅自改动的`credentials`保存的文件,  同时还有一个`config/credentials.yml.enc`文件是它的映射, 这个文件是一个yaml文件, 敏感信息的加密和解密再转存到`master.key`里就是靠它.

因此实际上, 我们只需要共享一次`master key`, 之后的版本只需要更新`config/credentials.yml.enc`文件, 并且通过版本控制工具进行分享, 就能避免直接以纯文本的形式保存敏感信息.

为了安全的保存我们的`STMP`的用户名和密码, 来式一下这个`credentials`是怎么玩的.

先执行如下命令

`EDITOR="vi" rails credentials:edit`

执行后, Rails会自动以`EDITOR`所指定的编辑器的形式打开Rails项目的`credentials`(即解码后的credentials.yml.enc), 我们只需要以正常写yml的形式在里面做项目相关的密钥的配置就行, Rails会自动进行加密处理.

此外, 上述命令中的`EDITOR`参数如果不使用的话, 直接执行`rails credentials:edit`, 则会取系统变量里的`$EDITOR`变量.

这些加密数据, Rails在运行时则是通过如下方法进行获取的.

```ruby
# 一个使用的配置的例子.
# Rails通过Rails.application.credentials.dig(:第一层, :第二层, ...)来拿到信息
# 或者, Rails.application.credentials.aws[:access_key_id]
amazon:
  service: S3
  access_key_id: <%= Rails.application.credentials.dig(:aws, :access_key_id) %>
  secret_access_key: <%= Rails.application.credentials.dig(:aws, :secret_access_key) %>
  region: us-east-1
  bucket: your_own_bucket-<%= Rails.env %>
```

之后我们到配置文件里做邮件发送服务器的配置. 注意不同的环境邮件发送的服务器一定要不一样,或者有些环境就别设定. 

```ruby
# development.rb
  config.action_mailer.default_url_options = { host: 'http://localhost:30000' }
  
  config.action_mailer.smtp_settings = {
    address: 'smtp.gmail.com',
    enable_starttls_auto: true,
    port: 587,
    authentication: :plain,
    user_name: Rails.application.credentials.smtp[:user_name],
    password: Rails.application.credentials.smtp[:password]
  }
```

在配置好后, 我们需要做的就是重启一下我们的服务器就好了, Rails会自动连上mailer服务器.

#### Configuring Application Settings

除了`smtp_settings`之外, `action_mailer`还支持其他的配置, 当然我们可以把他们都配置在`environments`文件里, 也可以分开设定在`initializers`里来分开配置, 如下

Option | Description
---|---|
raise_delivery_errors | 当邮件发送报错时, 是否抛出异常
delivery_method | 使用哪个子系统发送邮件, 可选项有`:smtp, :sendmail, :file, :test`
perform_deliveries | 记录邮件是否被确定发送过去了(没有硬退,失败的情况)
deliveries | 当`delivery_method`为`:test`时, 以数组的形式保存所有模拟发送的邮件. 该设定在写`test_case`的时候很有用, 我们可以通过这个设定来测试邮件发送功能.
default_options | 允许我们设定邮件的默认参数, 比如`from, reply_to, cc`等
default_url_options | 允许我们设定邮件的默认发件地址来提供给在邮件模版里的url_helper使用, 比如`host`来设定正确的域名
asset_host | 允许我们设定邮件要使用的图片,附件之类的的基础来源`URL`

注意: 当我们创建一个新的Rails应用的时候, 所有的配置文件都会自动为每个环境配置好默认的配置, 请按需自定义配置.

### Sending Email

要发送邮件, 我们需要通过命令来创建Action Mailer会使用到的`mailer`控制器以及邮件会使用到的模版. 注意Action Mailer是Rails默认自动开启的, 因此不需要执行类似于我们之前章节看到的`active_storage:install`之类的命令.

执行如下命令来创建一个mailer

`rails g mailer Notifier email_friend`

上述命令会给我们创建一个叫做`Notifier`的mailer类, 该类会带一个叫做`email_friend`的方法用于触发邮件发送. 其继承自`ApplicationMailer`, 根类则是`ActionMailer::Base`

所有邮件相关的功能都会集中在`app/mailers`文件夹下, 相关的views模版则都会以`xxx_mailer`来进行统一管理.

邮件发送提供了2种模版, 一种是`text`的, 一种是`html`的, 可以按需使用.

接着我们来看下代码

首先是`application_mailer.rb`

```ruby
class ApplicationMailer < ActionMailer::Base
  default from: "from@example.com"
  layout "mailer"
end
```

上述代码使用了2个回调, 分别作用如下

- `default`: 接收一个hash作为参数, 这里的`from`表示的就是邮件里的`from`字段, 表示发件人. 如果其他mailer也设定了这个参数, 则会覆盖全局的这个. 全局这个需要和在`environments`里配的一样
- `layout`: 同我们在`controller`里看到的layout, 表示邮件发送的根模版, 会自动取`views/layouts/mailer.html(text).erb`作为根模版. 其他后续生成的也是以插入替换的形式进行的.

然后我们来看下生成的mailer类

```ruby
class NotifierMailer < ApplicationMailer

  # Subject can be set in your I18n file at config/locales/en.yml
  # with the following lookup:
  #
  #   en.notifier_mailer.email_friend.subject
  #
  def email_friend
    @greeting = "Hi"

    mail to: "to@example.org"
  end
end
```

这边能看到可以设定i18n的东西, 后续章节介绍, 然后我们创建的`email_friend`方法定义了一个变量, 然后执行了`mail`方法, 传递了一个带`to`的`hash`. 来看下这个`mail`方法是怎么玩的

Option| Description| Example
---|---|---|
subject | 邮件的subject字段内容 | subject: "Action Mailer is powerful"
to | 字符串或者数组用来表示邮件的发送地址 | to: "friend@example.com"
from | 字符串表示邮件发送者 | from: "sender@example.com"
reply_to | 字符串表示邮件回复的地址 | reply: "sender@example.com"
date | 日期的header,默认取发送时间 | date: Time.now
cc | 字符串或者数组用来表示抄送给谁 | cc: "admin@example.com"
bcc | 字符串或者数组用来表示密抄给谁 | bcc: ["support@example.com", "sales@example.com"]

### Handling Basic Email








